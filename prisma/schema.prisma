generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum WorkspaceRole {
  admin
  editor
  viewer
}

model User {
  id                     String               @id @default(cuid())
  name                   String?
  email                  String?              @unique
  emailVerified          DateTime?
  image                  String?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  accounts               Account[]
  sessions               Session[]
  authenticators         Authenticator[]
  passwordCredential     PasswordCredential?
  passwordResetTokens    PasswordResetToken[]
  createdWorkspaces      Workspace[]          @relation("WorkspaceCreatedBy")
  workspaceMemberships   WorkspaceMember[]
  usedWorkspaceInvites   WorkspaceInvite[]    @relation("WorkspaceInviteUsedBy")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

model PasswordCredential {
  id            String   @id @default(cuid())
  userId        String   @unique
  passwordHash  String
  passwordAlgo  String   @default("scrypt-v1")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String    @unique
  expiresAt  DateTime
  consumedAt DateTime?
  createdAt  DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Workspace {
  id              String            @id @default(cuid())
  slug            String            @unique
  displayName     String
  createdByUserId String
  revision        Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  createdBy User @relation("WorkspaceCreatedBy", fields: [createdByUserId], references: [id], onDelete: Cascade)

  members  WorkspaceMember[]
  invites  WorkspaceInvite[]
  links    WorkspaceLink[]
  notes    WorkspaceNote[]
  snippets WorkspaceSnippet[]
  statuses WorkspaceStatus[]

  @@index([createdByUserId])
}

model WorkspaceMember {
  id          String        @id @default(cuid())
  workspaceId String
  userId      String
  role        WorkspaceRole
  canInvite   Boolean       @default(false)
  joinedAt    DateTime      @default(now())
  removedAt   DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdInvites WorkspaceInvite[] @relation("WorkspaceInviteCreatedByMember")

  @@unique([workspaceId, userId])
  @@index([workspaceId, removedAt])
  @@index([userId, removedAt])
}

model WorkspaceInvite {
  id                String        @id @default(cuid())
  workspaceId       String
  slug              String        @unique
  roleToGrant       WorkspaceRole
  codeHash          String
  expiresAt         DateTime
  maxUses           Int           @default(1)
  useCount          Int           @default(0)
  createdByMemberId String
  revokedAt         DateTime?
  usedByUserId      String?
  createdAt         DateTime      @default(now())

  workspace       Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdByMember WorkspaceMember @relation("WorkspaceInviteCreatedByMember", fields: [createdByMemberId], references: [id], onDelete: Cascade)
  usedByUser      User?           @relation("WorkspaceInviteUsedBy", fields: [usedByUserId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([workspaceId, revokedAt])
}

model WorkspaceLink {
  id          String   @id @default(cuid())
  workspaceId String
  itemId      String
  position    Int
  title       String
  category    String
  url         String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, itemId])
  @@index([workspaceId, position])
}

model WorkspaceNote {
  id          String   @id @default(cuid())
  workspaceId String
  itemId      String
  position    Int
  title       String
  category    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, itemId])
  @@index([workspaceId, position])
}

model WorkspaceSnippet {
  id          String   @id @default(cuid())
  workspaceId String
  itemId      String
  position    Int
  title       String
  language    String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, itemId])
  @@index([workspaceId, position])
}

model WorkspaceStatus {
  id           String   @id @default(cuid())
  workspaceId  String
  itemId       String
  position     Int
  title        String
  url          String
  variant      String?
  state        String
  responseTime Int      @default(0)
  lastChecked  DateTime @default(now())
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, itemId])
  @@index([workspaceId, position])
}
